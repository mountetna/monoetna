name: Run tests & prepare package.json updates
on:
  push:
    branches:
      - '*'
      - '*/*'
      - '*/*/*'
      - '!master'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - id: cache-docker
      uses: actions/cache@v2
      with:
        path: /tmp/docker-registry
        key: docker-registry-{{ hashFiles('**/docker/**') }}-{{ hashFiles('**/Dockerfile.development') }}-{{ hashFiles('**/docker-compose.yml') }}
    - name: Ready images from cache
      run: |
        docker run -d -p 5000:5000 --restart=always --name registry -v /tmp/docker-registry:/var/lib/registry registry:2 && npx wait-on tcp:5000
        REPOSITORY=localhost:5000 make tag
        cd docker && docker-compose -p monoetna pull || true
    - run: docker-build
    - name: Run metis test suite
      id: metis_first_test_run
      run: |
        make -C metis test
    - name: Run janus test suite
      id: janus_first_test_run
      run: |
        make -C janus test
    - name: Run etna test suite
      id: etna_first_test_run
      run: |
        make -C etna test
    - run: cd docker && docker-compose -p monoetna push || true
      if: steps.cache-docker.outputs.cache-hit != 'true'
