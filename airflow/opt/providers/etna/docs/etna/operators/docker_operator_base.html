<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 10.0.1"/>
    <title>etna.operators.docker_operator_base API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;}nav.pdoc{--pad:1.75rem;--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc li{display:block;margin:0;padding:.2rem 0 .2rem var(--indent);transition:all 100ms;}nav.pdoc > div > ul > li{padding-left:0;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.pdoc details{filter:opacity(1);}.pdoc details:not([open]){height:0;}.pdoc details > summary{position:absolute;top:-35px;right:0;font-size:.75rem;color:var(--muted);padding:0 .7em;user-select:none;cursor:pointer;}.pdoc details > summary:focus{outline:0;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc > section:first-of-type > .docstring{margin-bottom:2.5rem;}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc .headerlink{position:absolute;width:0;margin-left:-1.5rem;line-height:1.4rem;font-size:1.5rem;font-weight:normal;transition:all 100ms ease-in-out;opacity:0;user-select:none;}.pdoc .attr > .headerlink{margin-left:-2.5rem;}.pdoc *:hover > .headerlink,.pdoc *:target > .attr > .headerlink{opacity:1;}.pdoc .attr{display:block;color:var(--text);margin:.5rem 0 .5rem;padding:.4rem 5rem .4rem 1rem;background-color:var(--accent);}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{white-space:pre-wrap;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../operators.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;etna.operators</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="class" href="#SwarmSharedData">SwarmSharedData</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SwarmSharedData.__init__">SwarmSharedData</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#DockerOperatorBase">DockerOperatorBase</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DockerOperatorBase.__init__">DockerOperatorBase</a>
                        </li>
                        <li>
                                <a class="variable" href="#DockerOperatorBase.serialize_last_output">serialize_last_output</a>
                        </li>
                        <li>
                                <a class="variable" href="#DockerOperatorBase.template_fields">template_fields</a>
                        </li>
                        <li>
                                <a class="variable" href="#DockerOperatorBase.template_fields_renderers">template_fields_renderers</a>
                        </li>
                        <li>
                                <a class="function" href="#DockerOperatorBase.accepts">accepts</a>
                        </li>
                        <li>
                                <a class="function" href="#DockerOperatorBase.pre_execute">pre_execute</a>
                        </li>
                        <li>
                                <a class="variable" href="#DockerOperatorBase.swarm_shared_data">swarm_shared_data</a>
                        </li>
                        <li>
                                <a class="function" href="#DockerOperatorBase.set_input">set_input</a>
                        </li>
                        <li>
                                <a class="function" href="#DockerOperatorBase.shared_data_labeling">shared_data_labeling</a>
                        </li>
                        <li>
                                <a class="variable" href="#DockerOperatorBase.task_name">task_name</a>
                        </li>
                        <li>
                                <a class="variable" href="#DockerOperatorBase.successful_states">successful_states</a>
                        </li>
                        <li>
                                <a class="variable" href="#DockerOperatorBase.completed_states">completed_states</a>
                        </li>
                        <li>
                                <a class="variable" href="#DockerOperatorBase.cleanup">cleanup</a>
                        </li>
                        <li>
                                <a class="function" href="#DockerOperatorBase.on_kill">on_kill</a>
                        </li>
                        <li>
                                <a class="function" href="#DockerOperatorBase.execute">execute</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#write_logs_and_yield_last">write_logs_and_yield_last</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section>
                    <h1 class="modulename">
<a href="./../../etna.html">etna</a><wbr>.<a href="./../operators.html">operators</a><wbr>.docker_operator_base    </h1>

                
                        <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Mapping</span><span class="p">,</span>
    <span class="n">Iterator</span><span class="p">,</span>
    <span class="n">Set</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">MutableMapping</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">hashlib</span>

<span class="kn">import</span> <span class="nn">io</span>

<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">from</span> <span class="nn">airflow</span> <span class="kn">import</span> <span class="n">AirflowException</span>
<span class="kn">from</span> <span class="nn">airflow.models</span> <span class="kn">import</span> <span class="n">TaskInstance</span><span class="p">,</span> <span class="n">XCom</span><span class="p">,</span> <span class="n">BaseOperator</span>
<span class="kn">from</span> <span class="nn">airflow.models.xcom_arg</span> <span class="kn">import</span> <span class="n">XComArg</span>
<span class="kn">from</span> <span class="nn">dateutil</span> <span class="kn">import</span> <span class="n">parser</span>
<span class="kn">from</span> <span class="nn">docker</span> <span class="kn">import</span> <span class="n">APIClient</span>

<span class="kn">from</span> <span class="nn">etna.utils.gater</span> <span class="kn">import</span> <span class="n">RetryGater</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SwarmSharedData</span><span class="p">:</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="n">remote_path</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span> <span class="nc">DockerOperatorBase</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>
    <span class="n">terminated_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">_swarm_shared_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SwarmSharedData</span><span class="p">]</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">serialize_last_output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cli</span><span class="p">:</span> <span class="n">APIClient</span>
    <span class="n">ti</span><span class="p">:</span> <span class="n">TaskInstance</span>
    <span class="n">docker_base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="n">file_inputs</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">XComArg</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span>
    <span class="n">resolved_swarm_shared_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SwarmSharedData</span><span class="p">]</span>

    <span class="n">template_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">,)</span>
    <span class="n">template_fields_renderers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">swarm_shared_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">SwarmSharedData</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">serialize_last_output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">docker_base_url</span><span class="o">=</span><span class="s2">&quot;unix://var/run/docker.sock&quot;</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
        <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_swarm_shared_data</span> <span class="o">=</span> <span class="n">swarm_shared_data</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serialize_last_output</span> <span class="o">=</span> <span class="n">serialize_last_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">docker_base_url</span> <span class="o">=</span> <span class="n">docker_base_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_inputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolved_swarm_shared_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">DockerOperatorBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">accepts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">file_names</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">file_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;docker operator should use .accepts to match inputs size, configured for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s2"> but got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">xarg</span><span class="p">,</span> <span class="n">file_arg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">file_arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">xarg</span>
        <span class="k">return</span> <span class="n">XComArg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pre_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DockerOperatorBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">pre_execute</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_base_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ti</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;ti&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resolved_swarm_shared_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">file_input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">bin</span><span class="p">:</span> <span class="nb">bytes</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="n">XComArg</span><span class="p">):</span>
                <span class="nb">bin</span> <span class="o">=</span> <span class="n">XCom</span><span class="o">.</span><span class="n">serialize_value</span><span class="p">(</span><span class="n">file_input</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="nb">bin</span> <span class="o">=</span> <span class="n">file_input</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_input</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;docker operator input </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> was not a valid path: </span><span class="si">{</span><span class="n">file_input</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_input</span><span class="p">):</span>
                    <span class="n">buff</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">buff</span><span class="p">)</span>
                    <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                    <span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="nb">bin</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">bin</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="sa">f</span><span class="s2">&quot;Unexpected input to docker operator: Expected XComArg, str, or bytes, found </span><span class="si">{</span><span class="n">file_input</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">resolved_swarm_shared_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">SwarmSharedData</span><span class="p">(</span><span class="n">remote_path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">bin</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">swarm_shared_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_swarm_shared_data</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolved_swarm_shared_data</span>

    <span class="k">def</span> <span class="nf">set_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">XComArg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DockerOperatorBase&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">XComArg</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; was not instance of XComArg, str, or bytes!&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> only accepts string index keys&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">XComArg</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_upstream</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> is an invalid docker operator argument, must be a absolute path.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">shared_data_labeling</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;etna.operators.swarm_operator.shared_data&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">task_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ti</span><span class="o">.</span><span class="n">dag_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ti</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ti</span><span class="o">.</span><span class="n">run_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">digest</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">successful_states</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Oh no!&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">completed_states</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Oh no!&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_next_log_batch_since</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Oh no!&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;oh no!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_kill</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DockerOperatorBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_kill</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_check_task</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;oh no!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_start_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;oh no!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_task</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Consuming logs now:&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_task_run</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Task terminated: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminated_state</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminated_state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successful_states</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span><span class="s2">&quot;Task did not complete successfully&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_process_task_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">logs_iter</span> <span class="o">=</span> <span class="n">write_logs_and_yield_last</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_log_batch_since</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># await the task being complete</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># While consuming logs</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">logs_iter</span><span class="p">)</span>

            <span class="n">state</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_task</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_states</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">terminated_state</span> <span class="o">=</span> <span class="n">state</span>
                <span class="k">break</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Then consume the remaining logs after a task completes, keeping the last log line</span>
        <span class="n">last_line</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">logs_iter</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminated_state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successful_states</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize_last_output</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize_last_output</span><span class="p">(</span><span class="n">last_line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">last_line</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">last_line</span><span class="p">)</span>


<span class="n">LOG_LINE_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">16384</span>  <span class="c1"># 16K</span>
<span class="n">MAX_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># 16K * 500 ~= 8mb</span>
<span class="n">LOG_TIMESTAMP_LEN</span> <span class="o">=</span> <span class="mi">30</span>


<span class="k">def</span> <span class="nf">write_logs_and_yield_last</span><span class="p">(</span>
    <span class="n">next_batch_since</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">],</span>
    <span class="n">log</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span>
    <span class="n">since_s</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
    <span class="n">since_t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">last_line</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">next_batch_buff</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">gater</span> <span class="o">=</span> <span class="n">RetryGater</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">buff</span> <span class="o">=</span> <span class="n">next_batch_since</span><span class="p">(</span><span class="n">since_t</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">rpc_error</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Error&quot;</span><span class="p">):</span>
                <span class="c1"># rpc error incoming.  Attempt a fresh new fetch. do NOT allow a yield after an error</span>
                <span class="c1"># since we need to ensure some sort of conclusion to fetching logs (and if we cannot, we&#39;d rather</span>
                <span class="c1"># timeout or error from connection, not rpc issues).</span>
                <span class="n">rpc_error</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">gater</span><span class="o">.</span><span class="n">gate</span><span class="p">(</span>
                    <span class="n">AirflowException</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Could not read docker logs, received rpc error: </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">break</span>

            <span class="c1"># We need a &#39;timestamp&#39; for the since call, but the string associated with the time may have higher precision</span>
            <span class="c1"># that we care about.  We compare using the higher precision string, but pass to the api the int.  This</span>
            <span class="c1"># will result in some overlap of results but we can dedup using the string for comparison.</span>
            <span class="c1"># In theory, logs can be lost if even the string precision is not string enough, but there isn&#39;t an easy way</span>
            <span class="c1"># around this since the api lacks a strictly increasing non duplicated value for consuming logs.</span>
            <span class="n">date_s</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">LOG_TIMESTAMP_LEN</span><span class="p">]</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_s</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">date_s</span> <span class="o">&lt;=</span> <span class="n">since_s</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">since_t</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">since_s</span> <span class="o">=</span> <span class="n">date_s</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">31</span><span class="p">:]</span>

            <span class="c1"># log messages &gt; 16K are broken into batches without newline separation, but including the timestamp</span>
            <span class="c1"># header which must be removed.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">LOG_LINE_BATCH_SIZE</span><span class="p">:</span>
                <span class="n">line_segments</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MAX_BATCH_SIZE</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                        <span class="k">break</span>
                    <span class="n">line_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">LOG_LINE_BATCH_SIZE</span><span class="p">])</span>
                    <span class="n">offset</span> <span class="o">+=</span> <span class="n">LOG_LINE_BATCH_SIZE</span> <span class="o">+</span> <span class="n">LOG_TIMESTAMP_LEN</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">line</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line_segments</span><span class="p">)</span>

            <span class="n">next_batch_buff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rpc_error</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">next_batch_buff</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">last_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">last_line</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">last_line</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">next_batch_buff</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="n">last_line</span> <span class="o">=</span> <span class="n">next_batch_buff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">next_batch_buff</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">gater</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">last_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">last_line</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
</pre></div>

        </details>

            </section>
                <section id="SwarmSharedData">
                                <div class="attr class">
        <a class="headerlink" href="#SwarmSharedData">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">SwarmSharedData</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">SwarmSharedData</span><span class="p">:</span>
    <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span>
    <span class="n">remote_path</span><span class="p">:</span> <span class="nb">str</span>
</pre></div>

        </details>

            <div class="docstring"><p>SwarmSharedData(data: bytes, remote_path: str)</p>
</div>


                            <div id="SwarmSharedData.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#SwarmSharedData.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">SwarmSharedData</span><span class="signature">(data: bytes, remote_path: str)</span>
    </div>

    
    

                            </div>
                </section>
                <section id="DockerOperatorBase">
                                <div class="attr class">
        <a class="headerlink" href="#DockerOperatorBase">#&nbsp;&nbsp</a>

        
        <span class="def">class</span>
        <span class="name">DockerOperatorBase</span><wbr>(<span class="base">airflow.models.baseoperator.BaseOperator</span>):
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">class</span> <span class="nc">DockerOperatorBase</span><span class="p">(</span><span class="n">BaseOperator</span><span class="p">):</span>
    <span class="n">terminated_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">_swarm_shared_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SwarmSharedData</span><span class="p">]</span>
    <span class="n">command</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">serialize_last_output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cli</span><span class="p">:</span> <span class="n">APIClient</span>
    <span class="n">ti</span><span class="p">:</span> <span class="n">TaskInstance</span>
    <span class="n">docker_base_url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">env</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

    <span class="n">file_inputs</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">XComArg</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span>
    <span class="n">resolved_swarm_shared_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">SwarmSharedData</span><span class="p">]</span>

    <span class="n">template_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;env&quot;</span><span class="p">,)</span>
    <span class="n">template_fields_renderers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">swarm_shared_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">SwarmSharedData</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">serialize_last_output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">docker_base_url</span><span class="o">=</span><span class="s2">&quot;unix://var/run/docker.sock&quot;</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
        <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_swarm_shared_data</span> <span class="o">=</span> <span class="n">swarm_shared_data</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serialize_last_output</span> <span class="o">=</span> <span class="n">serialize_last_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">docker_base_url</span> <span class="o">=</span> <span class="n">docker_base_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_inputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolved_swarm_shared_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">DockerOperatorBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">accepts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">file_names</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">file_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;docker operator should use .accepts to match inputs size, configured for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s2"> but got </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">xarg</span><span class="p">,</span> <span class="n">file_arg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">file_arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">xarg</span>
        <span class="k">return</span> <span class="n">XComArg</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">pre_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DockerOperatorBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">pre_execute</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_base_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ti</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;ti&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resolved_swarm_shared_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">file_input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">bin</span><span class="p">:</span> <span class="nb">bytes</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="n">XComArg</span><span class="p">):</span>
                <span class="nb">bin</span> <span class="o">=</span> <span class="n">XCom</span><span class="o">.</span><span class="n">serialize_value</span><span class="p">(</span><span class="n">file_input</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="nb">bin</span> <span class="o">=</span> <span class="n">file_input</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_input</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;docker operator input </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> was not a valid path: </span><span class="si">{</span><span class="n">file_input</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_input</span><span class="p">):</span>
                    <span class="n">buff</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">buff</span><span class="p">)</span>
                    <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                    <span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="nb">bin</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">bin</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="sa">f</span><span class="s2">&quot;Unexpected input to docker operator: Expected XComArg, str, or bytes, found </span><span class="si">{</span><span class="n">file_input</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">resolved_swarm_shared_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">SwarmSharedData</span><span class="p">(</span><span class="n">remote_path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">bin</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">swarm_shared_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_swarm_shared_data</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolved_swarm_shared_data</span>

    <span class="k">def</span> <span class="nf">set_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">XComArg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DockerOperatorBase&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">XComArg</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; was not instance of XComArg, str, or bytes!&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> only accepts string index keys&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">XComArg</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_upstream</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Key </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2"> is an invalid docker operator argument, must be a absolute path.&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">shared_data_labeling</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;etna.operators.swarm_operator.shared_data&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">task_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">digest</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ti</span><span class="o">.</span><span class="n">dag_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ti</span><span class="o">.</span><span class="n">task_id</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ti</span><span class="o">.</span><span class="n">run_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">digest</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">successful_states</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Oh no!&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">completed_states</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Oh no!&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_next_log_batch_since</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Oh no!&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;oh no!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_kill</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DockerOperatorBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_kill</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_check_task</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;oh no!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_start_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;oh no!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_task</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Consuming logs now:&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_task_run</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Task terminated: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminated_state</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminated_state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successful_states</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span><span class="s2">&quot;Task did not complete successfully&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_process_task_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="n">logs_iter</span> <span class="o">=</span> <span class="n">write_logs_and_yield_last</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_next_log_batch_since</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
        <span class="n">err</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># await the task being complete</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># While consuming logs</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">logs_iter</span><span class="p">)</span>

            <span class="n">state</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_task</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_states</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">terminated_state</span> <span class="o">=</span> <span class="n">state</span>
                <span class="k">break</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Then consume the remaining logs after a task completes, keeping the last log line</span>
        <span class="n">last_line</span><span class="p">:</span> <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">logs_iter</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">terminated_state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successful_states</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize_last_output</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize_last_output</span><span class="p">(</span><span class="n">last_line</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">last_line</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">last_line</span><span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>Abstract base class for all operators. Since operators create objects that
become nodes in the dag, BaseOperator contains many recursive methods for
dag crawling behavior. To derive this class, you are expected to override
the constructor as well as the 'execute' method.</p>

<p>Operators derived from this class should perform or trigger certain tasks
synchronously (wait for completion). Example of operators could be an
operator that runs a Pig job (PigOperator), a sensor operator that
waits for a partition to land in Hive (HiveSensorOperator), or one that
moves data from Hive to MySQL (Hive2MySqlOperator). Instances of these
operators (tasks) target specific operations, running specific scripts,
functions or data transfers.</p>

<p>This class is abstract and shouldn't be instantiated. Instantiating a
class derived from this one results in the creation of a task object,
which ultimately becomes a node in DAG objects. Task dependencies should
be set by using the set_upstream and/or set_downstream methods.</p>

<p>:param task_id: a unique, meaningful id for the task
:type task_id: str
:param owner: the owner of the task. Using a meaningful description
    (e.g. user/person/team/role name) to clarify ownership is recommended.
:type owner: str
:param email: the 'to' email address(es) used in email alerts. This can be a
    single email or multiple ones. Multiple addresses can be specified as a
    comma or semi-colon separated string or by passing a list of strings.
:type email: str or list[str]
:param email_on_retry: Indicates whether email alerts should be sent when a
    task is retried
:type email_on_retry: bool
:param email_on_failure: Indicates whether email alerts should be sent when
    a task failed
:type email_on_failure: bool
:param retries: the number of retries that should be performed before
    failing the task
:type retries: int
:param retry_delay: delay between retries
:type retry_delay: datetime.timedelta
:param retry_exponential_backoff: allow progressive longer waits between
    retries by using exponential backoff algorithm on retry delay (delay
    will be converted into seconds)
:type retry_exponential_backoff: bool
:param max_retry_delay: maximum delay interval between retries
:type max_retry_delay: datetime.timedelta
:param start_date: The <code>start_date</code> for the task, determines
    the <code>execution_date</code> for the first task instance. The best practice
    is to have the start_date rounded
    to your DAG's <code>schedule_interval</code>. Daily jobs have their start_date
    some day at 00:00:00, hourly jobs have their start_date at 00:00
    of a specific hour. Note that Airflow simply looks at the latest
    <code>execution_date</code> and adds the <code>schedule_interval</code> to determine
    the next <code>execution_date</code>. It is also very important
    to note that different tasks' dependencies
    need to line up in time. If task A depends on task B and their
    start_date are offset in a way that their execution_date don't line
    up, A's dependencies will never be met. If you are looking to delay
    a task, for example running a daily task at 2AM, look into the
    <code>TimeSensor</code> and <code>TimeDeltaSensor</code>. We advise against using
    dynamic <code>start_date</code> and recommend using fixed ones. Read the
    FAQ entry about start_date for more information.
:type start_date: datetime.datetime
:param end_date: if specified, the scheduler won't go beyond this date
:type end_date: datetime.datetime
:param depends_on_past: when set to true, task instances will run
    sequentially and only if the previous instance has succeeded or has been skipped.
    The task instance for the start_date is allowed to run.
:type depends_on_past: bool
:param wait_for_downstream: when set to true, an instance of task
    X will wait for tasks immediately downstream of the previous instance
    of task X to finish successfully or be skipped before it runs. This is useful if the
    different instances of a task X alter the same asset, and this asset
    is used by tasks downstream of task X. Note that depends_on_past
    is forced to True wherever wait_for_downstream is used. Also note that
    only tasks <em>immediately</em> downstream of the previous task instance are waited
    for; the statuses of any tasks further downstream are ignored.
:type wait_for_downstream: bool
:param dag: a reference to the dag the task is attached to (if any)
:type dag: airflow.models.DAG
:param priority_weight: priority weight of this task against other task.
    This allows the executor to trigger higher priority tasks before
    others when things get backed up. Set priority_weight as a higher
    number for more important tasks.
:type priority_weight: int
:param weight_rule: weighting method used for the effective total
    priority weight of the task. Options are:
    <code>{ downstream | upstream | absolute }</code> default is <code>downstream</code>
    When set to <code>downstream</code> the effective weight of the task is the
    aggregate sum of all downstream descendants. As a result, upstream
    tasks will have higher weight and will be scheduled more aggressively
    when using positive weight values. This is useful when you have
    multiple dag run instances and desire to have all upstream tasks to
    complete for all runs before each dag can continue processing
    downstream tasks. When set to <code>upstream</code> the effective weight is the
    aggregate sum of all upstream ancestors. This is the opposite where
    downstream tasks have higher weight and will be scheduled more
    aggressively when using positive weight values. This is useful when you
    have multiple dag run instances and prefer to have each dag complete
    before starting upstream tasks of other dags.  When set to
    <code>absolute</code>, the effective weight is the exact <code>priority_weight</code>
    specified without additional weighting. You may want to do this when
    you know exactly what priority weight each task should have.
    Additionally, when set to <code>absolute</code>, there is bonus effect of
    significantly speeding up the task creation process as for very large
    DAGs. Options can be set as string or using the constants defined in
    the static class <code>airflow.utils.WeightRule</code>
:type weight_rule: str
:param queue: which queue to target when running this job. Not
    all executors implement queue management, the CeleryExecutor
    does support targeting specific queues.
:type queue: str
:param pool: the slot pool this task should run in, slot pools are a
    way to limit concurrency for certain tasks
:type pool: str
:param pool_slots: the number of pool slots this task should use (&gt;= 1)
    Values less than 1 are not allowed.
:type pool_slots: int
:param sla: time by which the job is expected to succeed. Note that
    this represents the <code>timedelta</code> after the period is closed. For
    example if you set an SLA of 1 hour, the scheduler would send an email
    soon after 1:00AM on the <code>2016-01-02</code> if the <code>2016-01-01</code> instance
    has not succeeded yet.
    The scheduler pays special attention for jobs with an SLA and
    sends alert
    emails for SLA misses. SLA misses are also recorded in the database
    for future reference. All tasks that share the same SLA time
    get bundled in a single email, sent soon after that time. SLA
    notification are sent once and only once for each task instance.
:type sla: datetime.timedelta
:param execution_timeout: max time allowed for the execution of
    this task instance, if it goes beyond it will raise and fail.
:type execution_timeout: datetime.timedelta
:param on_failure_callback: a function to be called when a task instance
    of this task fails. a context dictionary is passed as a single
    parameter to this function. Context contains references to related
    objects to the task instance and is documented under the macros
    section of the API.
:type on_failure_callback: TaskStateChangeCallback
:param on_execute_callback: much like the <code>on_failure_callback</code> except
    that it is executed right before the task is executed.
:type on_execute_callback: TaskStateChangeCallback
:param on_retry_callback: much like the <code>on_failure_callback</code> except
    that it is executed when retries occur.
:type on_retry_callback: TaskStateChangeCallback
:param on_success_callback: much like the <code>on_failure_callback</code> except
    that it is executed when the task succeeds.
:type on_success_callback: TaskStateChangeCallback
:param pre_execute: a function to be called immediately before task
    execution, receiving a context dictionary; raising an exception will
    prevent the task from being executed.</p>

<pre><code>|experimental|
</code></pre>

<p>:type pre_execute: TaskPreExecuteHook
:param post_execute: a function to be called immediately after task
    execution, receiving a context dictionary and task result; raising an
    exception will prevent the task from succeeding.</p>

<pre><code>|experimental|
</code></pre>

<p>:type post_execute: TaskPostExecuteHook
:param trigger_rule: defines the rule by which dependencies are applied
    for the task to get triggered. Options are:
    <code>{ all_success | all_failed | all_done | one_success |
    one_failed | none_failed | none_failed_min_one_success | none_skipped | always}</code>
    default is <code>all_success</code>. Options can be set as string or
    using the constants defined in the static class
    <code>airflow.utils.TriggerRule</code>
:type trigger_rule: str
:param resources: A map of resource parameter names (the argument names of the
    Resources constructor) to their values.
:type resources: dict
:param run_as_user: unix username to impersonate while running the task
:type run_as_user: str
:param max_active_tis_per_dag: When set, a task will be able to limit the concurrent
    runs across execution_dates.
:type max_active_tis_per_dag: int
:param executor_config: Additional task-level configuration parameters that are
    interpreted by a specific executor. Parameters are namespaced by the name of
    executor.</p>

<pre><code>**Example**: to run this task in a specific docker container through
the KubernetesExecutor ::

    MyOperator(...,
        executor_config={
            "KubernetesExecutor":
                {"image": "myCustomDockerImage"}
        }
    )
</code></pre>

<p>:type executor_config: dict
:param do_xcom_push: if True, an XCom is pushed containing the Operator's
    result
:type do_xcom_push: bool
:param task_group: The TaskGroup to which the task should belong. This is typically provided when not
    using a TaskGroup as a context manager.
:type task_group: airflow.utils.task_group.TaskGroup
:param doc: Add documentation or notes to your Task objects that is visible in
    Task Instance details View in the Webserver
:type doc: str
:param doc_md: Add documentation (in Markdown format) or notes to your Task objects
    that is visible in Task Instance details View in the Webserver
:type doc_md: str
:param doc_rst: Add documentation (in RST format) or notes to your Task objects
    that is visible in Task Instance details View in the Webserver
:type doc_rst: str
:param doc_json: Add documentation (in JSON format) or notes to your Task objects
    that is visible in Task Instance details View in the Webserver
:type doc_json: str
:param doc_yaml: Add documentation (in YAML format) or notes to your Task objects
    that is visible in Task Instance details View in the Webserver
:type doc_yaml: str</p>
</div>


                            <div id="DockerOperatorBase.__init__" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#DockerOperatorBase.__init__">#&nbsp;&nbsp</a>

        
            <span class="name">DockerOperatorBase</span><span class="signature">(
    *args,
    command: List[str],
    swarm_shared_data: Union[List[<a href="#SwarmSharedData">etna.operators.docker_operator_base.SwarmSharedData</a>], NoneType] = None,
    serialize_last_output: Union[Callable[[bytes], Any], NoneType] = None,
    docker_base_url=&#39;unix://var/run/docker.sock&#39;,
    env: Mapping[str, str] = {},
    **kwds
)</span>
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">swarm_shared_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">SwarmSharedData</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">serialize_last_output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">],</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">docker_base_url</span><span class="o">=</span><span class="s2">&quot;unix://var/run/docker.sock&quot;</span><span class="p">,</span>
        <span class="n">env</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
        <span class="o">**</span><span class="n">kwds</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_swarm_shared_data</span> <span class="o">=</span> <span class="n">swarm_shared_data</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serialize_last_output</span> <span class="o">=</span> <span class="n">serialize_last_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">docker_base_url</span> <span class="o">=</span> <span class="n">docker_base_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_inputs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolved_swarm_shared_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">DockerOperatorBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="DockerOperatorBase.serialize_last_output" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#DockerOperatorBase.serialize_last_output">#&nbsp;&nbsp</a>

        <span class="name">serialize_last_output</span><span class="annotation">: Union[Callable[[bytes], Any], NoneType]</span><span class="default_value"> = None</span>
    </div>

    
    

                            </div>
                            <div id="DockerOperatorBase.template_fields" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#DockerOperatorBase.template_fields">#&nbsp;&nbsp</a>

        <span class="name">template_fields</span><span class="annotation">: Iterable[str]</span><span class="default_value"> = (&#39;env&#39;,)</span>
    </div>

    
    

                            </div>
                            <div id="DockerOperatorBase.template_fields_renderers" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#DockerOperatorBase.template_fields_renderers">#&nbsp;&nbsp</a>

        <span class="name">template_fields_renderers</span><span class="annotation">: Dict[str, str]</span><span class="default_value"> = {&#39;env&#39;: &#39;json&#39;}</span>
    </div>

    
    

                            </div>
                            <div id="DockerOperatorBase.accepts" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#DockerOperatorBase.accepts">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">accepts</span><span class="signature">(self, *file_names: str)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">accepts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">file_names</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">file_names</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="DockerOperatorBase.pre_execute" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#DockerOperatorBase.pre_execute">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">pre_execute</span><span class="signature">(self, context) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">pre_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DockerOperatorBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">pre_execute</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cli</span> <span class="o">=</span> <span class="n">APIClient</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">docker_base_url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ti</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;ti&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resolved_swarm_shared_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">file_input</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">bin</span><span class="p">:</span> <span class="nb">bytes</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="n">XComArg</span><span class="p">):</span>
                <span class="nb">bin</span> <span class="o">=</span> <span class="n">XCom</span><span class="o">.</span><span class="n">serialize_value</span><span class="p">(</span><span class="n">file_input</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="nb">bin</span> <span class="o">=</span> <span class="n">file_input</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_input</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;docker operator input </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> was not a valid path: </span><span class="si">{</span><span class="n">file_input</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">file_input</span><span class="p">):</span>
                    <span class="n">buff</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">buff</span><span class="p">)</span>
                    <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                    <span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="nb">bin</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">bin</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_input</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="sa">f</span><span class="s2">&quot;Unexpected input to docker operator: Expected XComArg, str, or bytes, found </span><span class="si">{</span><span class="n">file_input</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">resolved_swarm_shared_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">SwarmSharedData</span><span class="p">(</span><span class="n">remote_path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">bin</span><span class="p">)</span>
            <span class="p">)</span>
</pre></div>

        </details>

            <div class="docstring"><p>This hook is triggered right before self.execute() is called.</p>
</div>


                            </div>
                            <div id="DockerOperatorBase.swarm_shared_data" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#DockerOperatorBase.swarm_shared_data">#&nbsp;&nbsp</a>

        <span class="name">swarm_shared_data</span>
    </div>

    
    

                            </div>
                            <div id="DockerOperatorBase.set_input" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#DockerOperatorBase.set_input">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">set_input</span><span class="signature">(
    self,
    key: str,
    value: airflow.models.xcom_arg.XComArg
) -&gt; <a href="#DockerOperatorBase">etna.operators.docker_operator_base.DockerOperatorBase</a></span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">set_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">XComArg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;DockerOperatorBase&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="bp">self</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="DockerOperatorBase.shared_data_labeling" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#DockerOperatorBase.shared_data_labeling">#&nbsp;&nbsp</a>

                <div class="decorator">@staticmethod</div>

            <span class="def">def</span>
            <span class="name">shared_data_labeling</span><span class="signature">()</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">shared_data_labeling</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;etna.operators.swarm_operator.shared_data&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">}</span>
</pre></div>

        </details>

    

                            </div>
                            <div id="DockerOperatorBase.task_name" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#DockerOperatorBase.task_name">#&nbsp;&nbsp</a>

        <span class="name">task_name</span><span class="annotation">: str</span>
    </div>

    
    

                            </div>
                            <div id="DockerOperatorBase.successful_states" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#DockerOperatorBase.successful_states">#&nbsp;&nbsp</a>

        <span class="name">successful_states</span><span class="annotation">: Set[str]</span>
    </div>

    
    

                            </div>
                            <div id="DockerOperatorBase.completed_states" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#DockerOperatorBase.completed_states">#&nbsp;&nbsp</a>

        <span class="name">completed_states</span><span class="annotation">: Set[str]</span>
    </div>

    
    

                            </div>
                            <div id="DockerOperatorBase.cleanup" class="classattr">
                                            <div class="attr variable"><a class="headerlink" href="#DockerOperatorBase.cleanup">#&nbsp;&nbsp</a>

        <span class="name">cleanup</span>
    </div>

    
    

                            </div>
                            <div id="DockerOperatorBase.on_kill" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#DockerOperatorBase.on_kill">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">on_kill</span><span class="signature">(self) -&gt; None</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">on_kill</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DockerOperatorBase</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_kill</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>Override this method to cleanup subprocesses when a task instance
gets killed. Any use of the threading, subprocess or multiprocessing
module within an operator needs to be cleaned up or it will leave
ghost processes behind.</p>
</div>


                            </div>
                            <div id="DockerOperatorBase.execute" class="classattr">
                                        <div class="attr function"><a class="headerlink" href="#DockerOperatorBase.execute">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">execute</span><span class="signature">(self, context: Any)</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_task</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Consuming logs now:&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_task_run</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Task terminated: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminated_state</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminated_state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">successful_states</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AirflowException</span><span class="p">(</span><span class="s2">&quot;Task did not complete successfully&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
</pre></div>

        </details>

            <div class="docstring"><p>This is the main method to derive when creating an operator.
Context is the same dictionary used as when rendering jinja templates.</p>

<p>Refer to get_template_context for more context.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>airflow.models.baseoperator.BaseOperator</dt>
                                <dd id="DockerOperatorBase.template_ext" class="variable">template_ext</dd>
                <dd id="DockerOperatorBase.ui_color" class="variable">ui_color</dd>
                <dd id="DockerOperatorBase.ui_fgcolor" class="variable">ui_fgcolor</dd>
                <dd id="DockerOperatorBase.pool" class="variable">pool</dd>
                <dd id="DockerOperatorBase.shallow_copy_attrs" class="variable">shallow_copy_attrs</dd>
                <dd id="DockerOperatorBase.operator_extra_links" class="variable">operator_extra_links</dd>
                <dd id="DockerOperatorBase.supports_lineage" class="variable">supports_lineage</dd>
                <dd id="DockerOperatorBase.dag" class="variable">dag</dd>
                <dd id="DockerOperatorBase.add_inlets" class="function">add_inlets</dd>
                <dd id="DockerOperatorBase.add_outlets" class="function">add_outlets</dd>
                <dd id="DockerOperatorBase.get_inlet_defs" class="function">get_inlet_defs</dd>
                <dd id="DockerOperatorBase.get_outlet_defs" class="function">get_outlet_defs</dd>
                <dd id="DockerOperatorBase.has_dag" class="function">has_dag</dd>
                <dd id="DockerOperatorBase.dag_id" class="variable">dag_id</dd>
                <dd id="DockerOperatorBase.deps" class="variable">deps</dd>
                <dd id="DockerOperatorBase.prepare_for_execution" class="function">prepare_for_execution</dd>
                <dd id="DockerOperatorBase.set_xcomargs_dependencies" class="function">set_xcomargs_dependencies</dd>
                <dd id="DockerOperatorBase.priority_weight_total" class="variable">priority_weight_total</dd>
                <dd id="DockerOperatorBase.operator_extra_link_dict" class="variable">operator_extra_link_dict</dd>
                <dd id="DockerOperatorBase.global_operator_extra_link_dict" class="variable">global_operator_extra_link_dict</dd>
                <dd id="DockerOperatorBase.post_execute" class="function">post_execute</dd>
                <dd id="DockerOperatorBase.render_template_fields" class="function">render_template_fields</dd>
                <dd id="DockerOperatorBase.render_template" class="function">render_template</dd>
                <dd id="DockerOperatorBase.get_template_env" class="function">get_template_env</dd>
                <dd id="DockerOperatorBase.prepare_template" class="function">prepare_template</dd>
                <dd id="DockerOperatorBase.resolve_template_files" class="function">resolve_template_files</dd>
                <dd id="DockerOperatorBase.upstream_list" class="variable">upstream_list</dd>
                <dd id="DockerOperatorBase.upstream_task_ids" class="variable">upstream_task_ids</dd>
                <dd id="DockerOperatorBase.downstream_list" class="variable">downstream_list</dd>
                <dd id="DockerOperatorBase.downstream_task_ids" class="variable">downstream_task_ids</dd>
                <dd id="DockerOperatorBase.clear" class="function">clear</dd>
                <dd id="DockerOperatorBase.get_task_instances" class="function">get_task_instances</dd>
                <dd id="DockerOperatorBase.get_flat_relative_ids" class="function">get_flat_relative_ids</dd>
                <dd id="DockerOperatorBase.get_flat_relatives" class="function">get_flat_relatives</dd>
                <dd id="DockerOperatorBase.run" class="function">run</dd>
                <dd id="DockerOperatorBase.dry_run" class="function">dry_run</dd>
                <dd id="DockerOperatorBase.get_direct_relative_ids" class="function">get_direct_relative_ids</dd>
                <dd id="DockerOperatorBase.get_direct_relatives" class="function">get_direct_relatives</dd>
                <dd id="DockerOperatorBase.task_type" class="variable">task_type</dd>
                <dd id="DockerOperatorBase.add_only_new" class="function">add_only_new</dd>
                <dd id="DockerOperatorBase.roots" class="variable">roots</dd>
                <dd id="DockerOperatorBase.leaves" class="variable">leaves</dd>
                <dd id="DockerOperatorBase.set_downstream" class="function">set_downstream</dd>
                <dd id="DockerOperatorBase.set_upstream" class="function">set_upstream</dd>
                <dd id="DockerOperatorBase.output" class="variable">output</dd>
                <dd id="DockerOperatorBase.xcom_push" class="function">xcom_push</dd>
                <dd id="DockerOperatorBase.xcom_pull" class="function">xcom_pull</dd>
                <dd id="DockerOperatorBase.extra_links" class="variable">extra_links</dd>
                <dd id="DockerOperatorBase.get_extra_links" class="function">get_extra_links</dd>
                <dd id="DockerOperatorBase.get_serialized_fields" class="function">get_serialized_fields</dd>
                <dd id="DockerOperatorBase.is_smart_sensor_compatible" class="function">is_smart_sensor_compatible</dd>
                <dd id="DockerOperatorBase.inherits_from_dummy_operator" class="variable">inherits_from_dummy_operator</dd>
                <dd id="DockerOperatorBase.defer" class="function">defer</dd>

            </div>
            <div><dt>airflow.utils.log.logging_mixin.LoggingMixin</dt>
                                <dd id="DockerOperatorBase.log" class="variable">log</dd>

            </div>
            <div><dt>airflow.models.taskmixin.TaskMixin</dt>
                                <dd id="DockerOperatorBase.update_relative" class="function">update_relative</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="write_logs_and_yield_last">
                            <div class="attr function"><a class="headerlink" href="#write_logs_and_yield_last">#&nbsp;&nbsp</a>

        
            <span class="def">def</span>
            <span class="name">write_logs_and_yield_last</span><span class="signature">(
    next_batch_since: Callable[[int], bytes],
    log: logging.Logger
) -&gt; Iterator[bytes]</span>:
    </div>

            <details>
            <summary>View Source</summary>
            <div class="pdoc-code codehilite"><pre><span></span><span class="k">def</span> <span class="nf">write_logs_and_yield_last</span><span class="p">(</span>
    <span class="n">next_batch_since</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">],</span>
    <span class="n">log</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]:</span>
    <span class="n">since_s</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
    <span class="n">since_t</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">last_line</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">next_batch_buff</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">gater</span> <span class="o">=</span> <span class="n">RetryGater</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">exp</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">buff</span> <span class="o">=</span> <span class="n">next_batch_since</span><span class="p">(</span><span class="n">since_t</span><span class="p">)</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">buff</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">rpc_error</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;Error&quot;</span><span class="p">):</span>
                <span class="c1"># rpc error incoming.  Attempt a fresh new fetch. do NOT allow a yield after an error</span>
                <span class="c1"># since we need to ensure some sort of conclusion to fetching logs (and if we cannot, we&#39;d rather</span>
                <span class="c1"># timeout or error from connection, not rpc issues).</span>
                <span class="n">rpc_error</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">gater</span><span class="o">.</span><span class="n">gate</span><span class="p">(</span>
                    <span class="n">AirflowException</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Could not read docker logs, received rpc error: </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">break</span>

            <span class="c1"># We need a &#39;timestamp&#39; for the since call, but the string associated with the time may have higher precision</span>
            <span class="c1"># that we care about.  We compare using the higher precision string, but pass to the api the int.  This</span>
            <span class="c1"># will result in some overlap of results but we can dedup using the string for comparison.</span>
            <span class="c1"># In theory, logs can be lost if even the string precision is not string enough, but there isn&#39;t an easy way</span>
            <span class="c1"># around this since the api lacks a strictly increasing non duplicated value for consuming logs.</span>
            <span class="n">date_s</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">LOG_TIMESTAMP_LEN</span><span class="p">]</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_s</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">date_s</span> <span class="o">&lt;=</span> <span class="n">since_s</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">since_t</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">since_s</span> <span class="o">=</span> <span class="n">date_s</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">31</span><span class="p">:]</span>

            <span class="c1"># log messages &gt; 16K are broken into batches without newline separation, but including the timestamp</span>
            <span class="c1"># header which must be removed.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">LOG_LINE_BATCH_SIZE</span><span class="p">:</span>
                <span class="n">line_segments</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MAX_BATCH_SIZE</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                        <span class="k">break</span>
                    <span class="n">line_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">LOG_LINE_BATCH_SIZE</span><span class="p">])</span>
                    <span class="n">offset</span> <span class="o">+=</span> <span class="n">LOG_LINE_BATCH_SIZE</span> <span class="o">+</span> <span class="n">LOG_TIMESTAMP_LEN</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">line</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line_segments</span><span class="p">)</span>

            <span class="n">next_batch_buff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rpc_error</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">next_batch_buff</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">last_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">last_line</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">last_line</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">next_batch_buff</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="n">last_line</span> <span class="o">=</span> <span class="n">next_batch_buff</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">next_batch_buff</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">gater</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">last_line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">last_line</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
</pre></div>

        </details>

    

                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span><span class="signature">${doc.signature}:</span>`;
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>