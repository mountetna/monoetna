networks:
  edge_net:
    ipam:
      driver: default
      config:
        - subnet: '172.16.238.0/24'
        - subnet: '2001:3984:3989::/64'

version: '3.4'

volumes:
  airflow-dags:
    driver: local
  airflow-metadata-db:
    driver: local

x-airflow-env:
  &airflow-env
  AIRFLOW__CORE__FERNET_KEY: abcdef
  AIRFLOW__CORE__EXECUTOR: LocalExecutor
  AIRFLOW__CORE__SQL_ALCHEMY_CONN:  "postgresql://developer:password@airflow_postgres:5432/airflow"

services:
  airflow_postgres:
    image: "postgres:11"
    environment:
      POSTGRES_USER: developer
      POSTGRES_PASSWORD: password
      POSTGRES_DB: airflow
    volumes:
      - airflow-metadata-db:/var/lib/postgresql/data
    command:
      - "postgres"
      - "-c"
      - "max_connections=150"

  airflow_ui:
    user: airflow
    image: airflow
    command: webserver
    volumes:
      - ./opt/plugins:/opt/airflow/plugins
      - airflow-dags:/opt/airflow/dags
#      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      <<: *airflow-env
    networks:
      - default
      - edge_net

  airflow_scheduler:
    image: airflow
    command: scheduler
    volumes:
      - ./opt/plugins:/opt/airflow/plugins
      - airflow-dags:/opt/airflow/dags
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      <<: *airflow-env

  airflow_init:
    image: airflow
    command: version
    environment:
      <<: *airflow-env
      _AIRFLOW_DB_UPGRADE: 'true'
      _AIRFLOW_WWW_USER_CREATE: 'true'
      _AIRFLOW_WWW_USER_USERNAME: etna
      _AIRFLOW_WWW_USER_PASSWORD: password
