---
title: "Downloading data from magma"
author:
- name: Daniel Bunis
  affiliation: Data Science CoLab, University of California San Francisco, San Francisco, CA
date: "Created: November 20, 2020"
output:
  BiocStyle::html_document:
    toc_float: true
package: magmaR
vignette: >
  %\VignetteIndexEntry{Downloading data from magma}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}    
---

```{r, echo=FALSE, results="hide", message=FALSE}
knitr::opts_chunk$set(error=FALSE, message=FALSE, warning=FALSE)
library(BiocStyle)
```

# Introduction

magmaR is an R-client for interfacing with, and downloading data from, magma the [fill in more]

## How it works

In general, magmaR functions will:

1. Take in inputs from the user.
2. Reformat those inputs into the structure magma understands.
3. Make a curl request to magma to obtain desired data.
4. Performs some level of, typically minimal, restructuring of the data.
5. Return the output.

### Data Restructuring Details

Often, the structure returned by magma will be a JSON. 

R does not have great built in support for the JSON structure. In these cases, the data will be converted to a nested list structure by the `jsonlite::fromJSON()` function.

Other times, the structure returned by magma will be a tsv, or more specifically, a long string conforming to tsv structure standards.

In these cases, the tsv-string will be transformed to a dataframe using the `readr::read_tsv()` function followed by `as.data.frame()`.

### Additional adjustments by certain functions with targetted return goals

A couple of functions, `retrieveMatrix()` and `retrieveMetadata()` perform some significant restructuring of data after initial return from magma. Exact details can be found below and within their respective documentation, but the overall idea is that:

- `retrieveMatrix()`: downloading an entire matrix in JSON format is very inefficient, so this function obtains chunks first, then appends those chunnks together.
- `retrieveMetadata()`: the exact method for constructing a magma/query call that would obtain data from one model (the `meta_modelName` input) which is linked to records of another model (the `target_modelName` input) is hard to predict. So, the function performs intermediate steps which determine how such data would be linked, then it pulls the desired, linked, data from the meta model, then it restructures that data into a dataframe that has one row per record of the target model.

# Installation

Currently, magmaR is only available through GitHub, and it will likely remain that way for the foreseeable future.

```{r, eval = FALSE}
if (!requireNamespace("remotes", quietly = TRUE))
    install.packages("remotes")
remotes::install_github("mountetna/etna", subdir = "packages/magmaR")
```

```{r}
library(magmaR)
```

# Authorization process, a.k.a. janus token utilization:

In order to access data in magma, a user needs to be authorized to do so. How this is achieved is via provision of a user-specific, temporary, string which we call a token.  This token can be obtained from https://janus.ucsf.edu/.

## Providing the token

Within magmaR, the token can be provided in either of 2 ways:

### Via prompt to the user upon first magmaR function call:

Recommended: If not given explicitly by the user as above, then the user will be prompted, one time, to provide their token.  The given value will then be stored within the user's global R environment as `.MAGMAR_TOKEN` and any future calls to magmaR functions will automatically fill in their `token` input with this value.

```{r, hide = TRUE, echo=FALSE}
.MAGMAR_TOKEN <- "NEVER_COMMIT_WITH_AN_ACTUAL_TOKEN"
```

```{r}
ids <- retrieveIds(
    projectName = "ipi",
    modelName = "rna_seq")
```

### Given explicity

All functions have a `token` input where this can be explicitly provided. This is not the generally recommended method, but may be necessary in some cases.

```{r, eval = FALSE}
ids_patient <- retrieveIds(
    projectName = "ipi",
    modelName = "patient",
    token = "<give_token_here>")
```

## When magma thinks you are unauthorized

If the curl request to magma returns that "You are unauthorized", magmaR will provide extra info so that users can fix this issue:

```
# Error message when magma sends back that user is unauthorized:
You are unauthorized. If you think this is a mistake, run `rm(.MAGMAR_TOKEN)` or update your 'token' input, then retry. 
```

# Controlling which version of magma to target (privileged users only)

For privileged users with access to the staging or development versions of magma, switching between which version is targeted is controlled either by giving `url.base = "production/staging/development-url"` in a function call, or by running `.MAGMAR_URL <- "production/staging/development-url`

```{r, eval = FALSE}
# Option 1: Given explicity in every function call:
ids_patient <- retrieveIds(
    projectName = "ipi",
    modelName = "patient",
    url.base = "http://magma.development.local")

# Option 2: Run this once
# Afterwards, all future calls will target this version
#   (unless they contain an explicit `url.base` input).
.MAGMAR_URL <- "http://magma.development.local"
ids_patient <- retrieveIds(
    projectName = "ipi",
    modelName = "patient")
```

# Helper functions

Although it is possible to rely on timur.ucsf.edu/<project_naame>/map or the Timur's search function to determine options that can be provided to `modelName`, `recordNames` or `attributeNames` inputs of the main `magmaR` functions that we will go through shortly, we also provide the helper functions below that allow users to achieve these goals without leaving R:

```{r}
# modelName options:
retrieveModels(
    projectName = "ipi")

# recordNames options:
retrieveIds(
    projectName = "ipi",
    modelName = "patient")[1:10]

# attributeNames options:
retrieveAttributes(
    projectName = "ipi",
    modelName = "patient")
```

For more complex needs like a complicated `query()` request, you might require accessing the project's template itself.  That can be achieved via the `retrieveTemplate()` function:

```{r}
# To retrieve the project template:
temp <- retrieveTemplate(
    projectName = "ipi")
```

# Main data download functions:

## `retreive()` & `retrieveJSON()`, analagous to `magma/retrieve`

This is probably the main workhorse function of `magmaR`. If your goal is to download demographic data for a specific patient of a project, or for all patients of the project, this is thee fucntion to use.

The basic structure is to provide which project, `projectName` and which model, `modelName`, that you want data for.

```{r}
df <- retrieve(
    projectName = "ipi",
    modelName = "patient")

head(df)
```

Optionally, a set of `recordNames` or `attributeNames` can be given as well to grab a more specific subset of data from the given project-model pair.

```{r}
df <- retrieve(
    projectName = "ipi",
    modelName = "patient",
    recordNames = c("IPIADR001", "IPIADR002"),
    attributeNames = "stain_version")

head(df)
```

The output format for the `retrieve()` function is a dataframe conversion of the tsv output given by a call to magma/retrieve with the json equivalent of `format = "tsv"`.

However, ceratin data types, such as matrix data, are not actually obtained via magma/retrieve when `format = "tsv"`.

For these data types, the `retrieveJSON()` function can be used to retrieve such data via the a magma/retrieve call with `format = "json"`.

Or, specifically, when the desired data is a matrix, `retrieveMatrix()` can be used instead. More details on that function are further below.

```{r restJSON}
json <- retrieveJSON(
    projectName = "ipi",
    modelName = "patient",
    recordNames = c("IPIADR002.T1.rna.live", "IPIADR002.T1.rna.stroma"),
    attributeNames = "stain_version")
```

### Additional inputs

`filter`, `page`, and `page_size` inputs of `magma/retrieve` can also be used.

```{r}
json <- retrieveJSON(
    projectName = "ipi",
    modelName = "patient",
    recordNames = c("IPIADR002.T1.rna.live", "IPIADR002.T1.rna.stroma"),
    attributeNames = "stain_version",
    filter = "ipi_number~GYN",
    pageSize = 25,
    page = 1
    )
```

## `query()`, analagous to `magma/query`

The Magma Query API lets you pull data out of Magma through an expressive query interface. Often, if you want a specific set of data, but only for samples where attributeX has a certain property, this is the endpoint you want.

But note: the format of such calls can be a bit complicated, so it is recommended that you check if `retreiveMatrix()` or `retreiveMetadata()` might better serve your purposes first.

For guidance on how to format such calls, see `?query` and https://mountetna.github.io/magma.html#query.

```{r query}
query_out <- query(
    projectName = "ipi",
    queryTerms = 
        list('rna_seq',
             '::all',
             'sample',
             '::identifier')
    )
```

The default output of this function is a list conversion of the direct json output of /query which contains 2 or 3 individual parts:

```{r}
names(query_out)
```

answer, type (optional), and format.

Alternatively, the output can be given as a dataframe if `format = "df"` is given.

```{r query2}
sample_ids_of_rnaseq_records <- query(
    projectName = "ipi",
    queryTerms = 
        list('rna_seq',
             '::all',
             'sample',
             '::identifier'),
    format = "df"
    )

head(sample_ids_of_rnaseq_records)
```

## `retrieveMatrix()`

Because matrices are a very common data structure that is not returned by /retrieve with the easier to use for a user "tsv" format, we provide a simple function, which wraps `retrieveJSON()` internally, to retrieve such data.

```{r matrix}
mat <- retrieveMatrix(
    projectName = "ipi",
    modelName = "rna_seq",
    recordNames = ids[grepl("live2",ids)],
    attributeNames = "gene_tpm")

head(mat, n = c(6,2))
```

Details:

Under the hood, an internal `.matrix_retrieval_chunk()` function grabs data with `retrieveJSON()` for 10 records at a time. These data are then converted to matrix columns.  After all chunks are obtained, they are combined into one single matrix which will have column names = `recordNames` and rownames grabbed from the model's template. For rna_seq data like in the example here, those rownames would be the Ensembl gene ids that each row of the matrix represents.

## `retrieveMetadata()`

This function attempts to simplify the process of obtaining "metadata" from model X for "target data" from model Y. For example, this function could be used to extract demographic data for the "ipi" project that is linked to samples with rna_seq data.

```{r meta}
meta <- retrieveMetadata(
    projectName = "ipi",
    meta_modelName = "sample",
    meta_attributeNames = "all",
    target_modelName = "rna_seq",
    target_recordNames = ids[grepl("live2",ids)])

head(meta, n = c(6,10))
```

Details:

Internally, the function first determines the model -> model path for navigating between the meta and target models. At the moment, ONLY parent links are used for this purpose, but utilization of link attributes is planned. Then, `query()`s based on these paths are utilized to obtain how target-model and meta-model recordNames are linked. Next, requested metadata (`meta_attributeNames`, and `target_modelNames`) is `retrieve()`d. Next, if there is more than 1:1 mapping between meta model records to target model records, the metadata is expanded in order to have one output row per `target_recordNames`. Finally, this data is output as a dataframe with rows = `target_recordNames` and columns of linkage record identifiers and of each requested meta-model attribute.

Now we could use these metadata to explore the rnaseq data thatwe had downloaded right beforehand:

```{r}
library(dittoSeq)

# Clean metadata
meta <- meta[!is.na(meta$rna_seq.x),]
rownames(meta) <- meta$rna_seq.x

# Make plot with dittoSeq
sce <- importDittoBulk(
  list(counts = mat),
  metadata = meta
)
dittoBoxPlot(sce, getGenes(sce)[3], group.by = "tissue_type")
```

# Session information

```{r}
sessionInfo()
```
