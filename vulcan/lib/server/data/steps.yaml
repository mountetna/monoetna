#!/usr/bin/env cwl-runner
cwlVersion: v1.1
class: Workflow

requirements:
  ResourceRequirement:
    coresMax: 1
    ramMin: 100 # just a default, could be lowered
  SchemaDefRequirement:
    types:
      - $import: mvir1-sc_rna_seq_pool-names.yaml

inputs:
  sc_rna_seq_pools:
    type:
      type: array
      items: mvir1-sc_rna_seq_pool-names.yaml#sc_rna_seq_pool
      label: 'SC RNA Seq Pool record names'
  min_nCounts:
    type: int
    default: 200
    label: 'minimum counts per cell'
  max_nCounts:
    type: int
    default: 30000
    label: 'maximum counts per cell'
  min_nFeatures:
    type: int
    default: 100
    label: 'minimum genes/features per cell'
  max_per_mito:
    type: int
    default: 20
    label: 'maximum percent of mitochondrial reads per cell'
  max_per_ribo:
    type: int
    default: 50
    label: 'maximum percent of ribosomal reads per cell'
  regress_nCounts:
    type: boolean
    default: false
    label: nCounts
  regress_nFeatures:
    type: boolean
    default: false
    label: nFeatures
  regress_per_mito:
    type: boolean
    default: false
    label: '% mito'
  regress_per_ribo:
    type: boolean
    default: false
    label: '% ribo'
  max_pc:
    type: int
    default: 15
    label: 'Maximum number of Principal Components'

outputs:
  mvir1_sc_rna_seq_pool_names:
    type: File
    outputSource: query_magma/sc_rna_seq_pool_names
  subset_data:
    type: File
    outputSource: subset_normalize_and_select_features/sc_rna_seq_normalized_data
  pc_data:
    type: File
    outputSource: regress_and_pca/pca_output_data
  umap_data:
    type: File
    outputSource: umap/umap_data

steps:
  query_magma:
    run: query-mvir1-sc_rna_seq_pools.cwl
    in: []
    out: [sc_rna_seq_pool_names]
  subset_normalize_and_select_features:
    run: subset_normalize_and_select_features.cwl
    in:
      sc_rna_seq_pools: sc_rna_seq_pools
      min_nCounts: min_nCounts
      max_nCounts: max_nCounts
      min_nFeatures: min_nFeatures
      max_per_mito: max_per_mito
      max_per_ribo: max_per_ribo
    out: [sc_rna_seq_normalized_data]
  regress_and_pca:
    run: regress_and_pca.cwl
    in:
      data: subset_normalize_and_select_features/sc_rna_seq_normalized_data
      counts: regress_nCounts
      genes: regress_nFeatures
      per_mito: regress_per_mito
      per_ribo: regress_per_ribo
    out: [pca_output_data]
  umap:
    run: umap.cwl
    in:
      data: regress_and_pca/pca_output_data
      max_pc: max_pc
    out: [umap_data]
