apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: metis-linker-workflow-
  namespace: argo
spec:
  entrypoint: metis-linker
  onExit: record-runtime-meta
  imagePullSecrets:
    - name: hub.docker.com
  templates:
    - name: metis-linker
      steps:
        - - name: metis-linker
            templateRef:
              name: run-job-template
              template: run-job
            arguments:
              parameters:
                - name: job
                  value: "metis_linker"
                - name: config_id
                  value: "{{workflow.parameters.config_id}}"
                - name: version_number
                  value: "{{workflow.parameters.version_number}}"
    - name: record-runtime-meta
      container:
        image: etnaagent/polyphemus:production
        command: ["/bin/sh", "-c"]
        args:
          - |
            /app/bin/polyphemus get_runtime_metadata "{{workflow.uid}}" \
            '$(argo get --output=json {{workflow.name}} -n {{workflow.namespace}})' \
            '$(argo logs {{workflow.name}})'