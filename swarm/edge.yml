version: '3.8'
services:

  edge-apache:
    labels:
      - autoupdate=true
    image: etnaagent/edge-apache:production
    volumes:
      - httpd.conf.d:/usr/opt/httpd.conf.d:ro
      - /etc/ssl:/etc/ssl:ro
    deploy:
      mode: replicated
      replicas: 1
      placement: &edge-placement
        constraints:
          - node.role == worker
          - node.labels.is_edge == true
    networks:
      - edge_bridge

  apply-config: &apply-config
    configs:
      - app.include.erb
      - main.conf
      - source: edge_config.sh
        target: /script/config.sh
    image: etnaagent/config-agent:production
    volumes:
      - httpd.conf.d:/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    deploy:
      labels:
        - autoupdate=true
      mode: replicated
      replicas: 1
      restart_policy:
        condition: none
      placement:
        <<: *edge-placement

  test-config:
    <<: *apply-config
    volumes:
      - httpd.conf.d.test:/config
    environment:
      DRY_RUN: 1

volumes:
  # Contains the materialized configuration for each app, as well as main.conf.
  httpd.conf.d:
  httpd.conf.d.test:

networks:
  edge_bridge:
    external: true

configs:
  app.include.erb:
    external: true
  main.conf:
    external: true
  edge_config.sh:
    external: true
