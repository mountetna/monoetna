version: '3.8'
services:
  edge-apache:
    labels:
      - autoupdate=true
    image: etnaagent/edge-apache:production
    volumes:
      - httpd.conf.d:/usr/opt/httpd.conf.d:ro
      - /etc/ssl:/etc/ssl:ro
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == worker
          - node.labels.is_edge == true
    networks:
      - edge_bridge
  apply-config:
    configs:
      - app.include.erb
      - main.conf
      - source: edge_config.sh
        target: /script/config.sh
    labels:
      - autoupdate=true
    image: etnaagent/config-agent:production
    volumes:
      - httpd.conf.d:/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: none
      placement:
        constraints:
          - node.role == worker
          - node.labels.is_edge == true
  test-config:
    configs:
      - app.include.erb
      - main.conf
      - edge_config.sh:/script/config.sh
    labels:
      - autoupdate=true
    image: etnaagent/config-agent:production
    environment:
      DRY_RUN: 1
    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: none
      placement:
        constraints:
          - node.role == worker
          - node.labels.is_edge == true


volumes:
  # Contains the materialized configuration for each app, as well as main.conf.
  httpd.conf.d:

networks:
  edge_bridge:
    external: true

configs:
  app.include.erb:
    external: true
  main.conf:
    external: true
  edge_config.sh:
    external: true
