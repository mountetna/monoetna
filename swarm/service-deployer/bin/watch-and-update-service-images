#!/usr/bin/env bash
set -eo pipefail

postToSlack() {
  post-to-slack "deployer on ${HOST_HOSTNAME}" "watchtower-ping" "$1"
}

findServices() {
  docker service ls --format "{{.Name}}" --filter label=autoupdate=true
}

findServiceImage() {
  docker service inspect "${1}" --format "{{.Spec.TaskTemplate.ContainerSpec.Image}}"
}

if [ -e /run/secrets/service-deployer-docker-login ]; then
  echo 'Login using /run/secrets/service-deployer-docker-login'
  docker login -u etnaagent -p "$(cat /run/secrets/service-deployer-docker-login)"
else
  echo 'Could not find docker login at /run/secrets/service-deployer-docker-login, proceeding unauthenticated.'
fi

while read serviceName; do
  image="$(findServiceImage $serviceName)"
  if [[ "$image" =~ ([^@]*)@(.*) ]]; then
    tag=${BASH_REMATCH[1]}
    sha=${BASH_REMATCH[2]}

    docker pull "$tag"
    newsha=$(docker image inspect "${tag}" | jq -r '.[].Id')

    if [ -f "/deployed/${serviceName}-${newsha}" ] || [[ "${sha}" == "${newsha}" ]]; then
       continue
    fi

    postToSlack "Updating ${tag} on ${serviceName}, issuing rolling restart"
    docker service update -d $serviceName --image "${tag}" --force
    touch "/deployed/${serviceName}-${newsha}"
  fi
done < <(findServices)