#!/usr/bin/env bash
set -eo pipefail



echo "Starting deployer..."

postToSlack() {
  post-to-slack "deployer on ${HOST_HOSTNAME}" "watchtower-ping" "$1"
}

findServices() {
  docker service ls --format "{{.Name}}" --filter label=autoupdate=true
}

findServiceImage() {
  docker service inspect "${1}" --format "{{.Spec.TaskTemplate.ContainerSpec.Image}}"
}

while read serviceName; do
  image="$(findServiceImage $serviceName)"
  if [[ "$image" =~ ([^@]*)@(.*) ]]; then
    tag=${BASH_REMATCH[1]}
    sha=${BASH_REMATCH[2]}

    docker pull "$tag"
    newsha=$(docker image inspect "${tag}" | jq -r '.[].Id')

    if [ -f "/deployed/${newsha}" ] || [[ "${sha}" == "${newsha}" ]]; then
       continue
    fi

    postToSlack "Updating ${tag} on ${serviceName}, issuing rolling restart"
    docker service update -d $serviceName --image "${tag}@${newsha}" --force
    touch "/deployed/${newsha}"
  fi
done < <(findServices)